<!DOCTYPE html>
<html>
  <head>
    <title>Leaflet Demo</title>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <style>
      body,
      html {
        height: 100%;
      }
      #map {
        width: 90%;
        height: 90%;
      }
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <!--<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="./slider.js"></script>-->
  </head>
  <body>
    <script>
      var waterData;
      $.getJSON("https://data.colorado.gov/api/views/i55n-9sba/rows.json", function(json){
        waterData = json

        // Create starting point for map
        initialLatLon = [waterData.data[0][45][1], waterData.data[0][45][2]]
        // Creates the Map
        var map = L.map('map').setView(initialLatLon, 15);

        // Visualize map using OpenStreetMap
        L.tileLayer('http://otile{s}.mqcdn.com/tiles/1.0.0/{type}/{z}/{x}/{y}.png', {
          maxZoom: 18,
          type: 'sat',
          attribution: 'OpenStreetMap and MapQuest',
          subdomains: '1234'
        }).addTo(map);

        // Add marker of first object
        var marker = L.marker(initialLatLon).addTo(map);

        function updateYear(sliderValue) {
          $('#year').text(sliderValue);
        }

        function updateMap(sliderValue, waterData) {
          var selectData = waterData.data.filter(function(e) {
            if (e[32]) {
              if (e[32].match(/\d{4}/)) {
                var year = e[32].match(/\d{4}/)[0];
                return year == sliderValue;
              } else {
                return false;
              }
            } else {
              return false;
            }
          });
          dataLimit = 20
          for (var i = 0; i < dataLimit; i++) {
            var data = selectData;
            if (data[i][45][1] && data[i][45][2]) {
              var lat = data[i][45][1];
              var lon = data[i][45][2];
              if (lat && lon) {
                pointLatLon = [lat, lon];
                mark = L.marker(pointLatLon).addTo(map);
                struct_type = data[i][9]
                name = data[i][10]
                water_source = data[i][11]
                county = data[i][14]
                info = data[i][44][0]
                popup_string = "<b>" +  name +
                              "</b><br><b>Source:</b> " + water_source +
                              "<br><b>Structure:</b> " + struct_type +
                              "<br><b>County:</b> " + county +
                              "<br><a href=" + info + ' target="_blank">Info</a>'
                mark.bindPopup(popup_string);
              }
            }
          }
        }

        $('#slider').change(function() {
          var sliderValue = $(this).val();
          updateMap(sliderValue, waterData);
          updateYear(sliderValue);
        });
      });
    </script>

    <p>
      <input type="range" min="1850" max="2022" id="slider">
      <div id="year"></div>
    </p>

    <div id="map"></div>

    <script src="http://leaflet.github.io/Leaflet.draw/leaflet.draw.js"></script>

  </body>
</html>
